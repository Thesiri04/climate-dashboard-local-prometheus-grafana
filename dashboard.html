<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard - Full View</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .card-header { display: flex; align-items: center; margin-bottom: 15px; }
        .card-icon { font-size: 2rem; margin-right: 15px; }
        .card-title { font-size: 1.3rem; font-weight: bold; color: #2d3436; }
        .card-value { font-size: 2.5rem; font-weight: bold; margin: 10px 0; }
        .temperature { color: #e17055; }
        .humidity { color: #0984e3; }
        .timestamp { color: #636e72; font-size: 0.9rem; margin-top: 10px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-online { background: #00b894; animation: pulse 2s infinite; }
        .status-offline { background: #e17055; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; text-align: center; }
        .stat-label { font-size: 0.9rem; color: #636e72; margin-bottom: 5px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #2d3436; }
        .btn { display: inline-block; padding: 12px 24px; background: #0984e3; color: white; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; border: none; cursor: pointer; font-size: 1rem; }
        .btn:hover { background: #074d7a; transform: translateY(-2px); }
        .btn-refresh { background: #00b894; }
        .btn-refresh:hover { background: #00a085; }
        .grafana-panel { width: 100%; height: 200px; border-radius: 8px; border: 0; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-cloud-sun"></i> Weather Dashboard</h1>
        <p>ระบบติดตามอุณหภูมิและความชื้น ESP32 + DHT11</p>
    </div>

    <div class="dashboard-grid">
        <!-- Current Temperature -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-thermometer-half card-icon temperature"></i>
                <div>
                    <div class="card-title">อุณหภูมิปัจจุบัน</div>
                    <div><span class="status-indicator" id="temp-status"></span><span id="temp-status-text">กำลังโหลด...</span></div>
                </div>
            </div>
            <div class="card-value temperature" id="current-temp">--°C</div>
            <div class="timestamp" id="temp-timestamp">--</div>
        </div>

        <!-- Current Humidity -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tint card-icon humidity"></i>
                <div>
                    <div class="card-title">ความชื้นปัจจุบัน</div>
                    <div><span class="status-indicator" id="humidity-status"></span><span id="humidity-status-text">กำลังโหลด...</span></div>
                </div>
            </div>
            <div class="card-value humidity" id="current-humidity">--%</div>
            <div class="timestamp" id="humidity-timestamp">--</div>
        </div>
    </div>

  
 
    <!-- Control Panel -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-cogs card-icon" style="color: #fd79a8;"></i>
            <div class="card-title">ควบคุมระบบ</div>
        </div>
        <div style="text-align:center;">
            <button class="btn btn-refresh" onclick="refreshData()"><i class="fas fa-sync-alt"></i> รีเฟรชข้อมูล</button>
            <a href="http://localhost:3000" target="_blank" class="btn"><i class="fas fa-chart-line"></i> เปิด Grafana</a>
            <a href="http://localhost:9090" target="_blank" class="btn"><i class="fas fa-fire"></i> เปิด Prometheus</a>
        </div>
    </div>
</div>

<script>
let isOnline = false;

function updateStatus(online) {
    isOnline = online;
    const tempStatus = document.getElementById('temp-status');
    const humidityStatus = document.getElementById('humidity-status');
    const tempStatusText = document.getElementById('temp-status-text');
    const humidityStatusText = document.getElementById('humidity-status-text');

    if (online) {
        tempStatus.className = 'status-indicator status-online';
        humidityStatus.className = 'status-indicator status-online';
        tempStatusText.textContent = 'เชื่อมต่อแล้ว';
        humidityStatusText.textContent = 'เชื่อมต่อแล้ว';
    } else {
        tempStatus.className = 'status-indicator status-offline';
        humidityStatus.className = 'status-indicator status-offline';
        tempStatusText.textContent = 'ไม่เชื่อมต่อ';
        humidityStatusText.textContent = 'ไม่เชื่อมต่อ';
    }
}

async function fetchLatestData() {
    try {
        const response = await fetch('http://localhost:5000/api/sensors/latest');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.success && result.data && result.data.sensorData) {
            const data = result.data.sensorData;
            updateStatus(true);
            document.getElementById('current-temp').textContent = `${data.temperature}°C`;
            document.getElementById('current-humidity').textContent = `${data.humidity}%`;
            const timestamp = new Date(data.timestamp).toLocaleString('th-TH');
            document.getElementById('temp-timestamp').textContent = `อัปเดต: ${timestamp}`;
            document.getElementById('humidity-timestamp').textContent = `อัปเดต: ${timestamp}`;
        } else {
            updateStatus(false);
            throw new Error('Invalid data structure received');
        }
    } catch (error) {
        console.error(error);
        updateStatus(false);
        document.getElementById('current-temp').textContent = 'Error';
        document.getElementById('current-humidity').textContent = 'Error';
        document.getElementById('temp-timestamp').textContent = 'ไม่สามารถเชื่อมต่อได้';
        document.getElementById('humidity-timestamp').textContent = 'ไม่สามารถเชื่อมต่อได้';
    }
}

async function fetchDailyStats() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`http://localhost:5000/api/sensors/range?startDate=${today}&endDate=${today}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.success && result.data && Array.isArray(result.data) && result.data.length > 0) {
            const sensorDataArray = result.data.map(r => r.sensorData).filter(d => d);
            const temperatures = sensorDataArray.map(d => d.temperature).filter(t => !isNaN(t));
            const humidities = sensorDataArray.map(d => d.humidity).filter(h => !isNaN(h));
            if (temperatures.length && humidities.length) {
                document.getElementById('max-temp').textContent = `${Math.max(...temperatures)}°C`;
                document.getElementById('min-temp').textContent = `${Math.min(...temperatures)}°C`;
                document.getElementById('max-humidity').textContent = `${Math.max(...humidities)}%`;
                document.getElementById('min-humidity').textContent = `${Math.min(...humidities)}%`;
                return;
            }
        }
        document.getElementById('max-temp').textContent = 'ไม่มีข้อมูล';
        document.getElementById('min-temp').textContent = 'ไม่มีข้อมูล';
        document.getElementById('max-humidity').textContent = 'ไม่มีข้อมูล';
        document.getElementById('min-humidity').textContent = 'ไม่มีข้อมูล';
    } catch (error) {
        console.error(error);
        document.getElementById('max-temp').textContent = 'Error';
        document.getElementById('min-temp').textContent = 'Error';
        document.getElementById('max-humidity').textContent = 'Error';
        document.getElementById('min-humidity').textContent = 'Error';
    }
}

// Refresh Grafana Panels
function refreshGrafanaPanels() {
    const panels = document.querySelectorAll('.grafana-panel');
    panels.forEach(iframe => { iframe.src = iframe.src; });
}

// Refresh all data
function refreshData() {
    fetchLatestData();
    fetchDailyStats();
    refreshGrafanaPanels();
}

document.addEventListener('DOMContentLoaded', function() {
    refreshData();
    setInterval(refreshData, 30000); // ทุก 30 วินาที
});
</script>
</body>
</html>
